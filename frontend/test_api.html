<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API åŠŸèƒ½æ¸¬è©¦é é¢</title>
    <link rel="icon" href="/åœ–ç‰‡/logo.png" type="image/x-icon">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
       
        .warning {
            background-color: #fff3e0;
            color: #e65100;
            border: 1px solid #ffcc02;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .notification-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .unread {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .read {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ API åŠŸèƒ½æ¸¬è©¦é é¢</h1>
    <p>æ¸¬è©¦æ‰“å¡è©•è«–çš„å–œæ­¡ã€æ”¶è—å’Œé€šçŸ¥åŠŸèƒ½</p>


    <!-- é€£æ¥æ¸¬è©¦ -->
    <div class="container">
        <h2>ğŸ”— é€£æ¥æ¸¬è©¦</h2>
        <button onclick="testConnection()">æ¸¬è©¦æœå‹™å™¨é€£æ¥</button>
        <div id="connectionResult"></div>
    </div>


    <!-- ç”¨æˆ¶ç™»å…¥å€åŸŸ -->
    <div class="container">
        <h2>ğŸ” ç”¨æˆ¶ç™»å…¥</h2>
        <p><strong>æ³¨æ„:</strong> é€™è£¡ä½¿ç”¨å¾Œç«¯ Session ç™»å…¥ï¼ˆ/api/accounts/ï¼‰ã€‚è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼ã€‚</p>
        <div class="warning">
            <strong>âš ï¸ é‡è¦æç¤º:</strong><br>
            1. å¯å…ˆç”¨ä¸‹æ–¹ã€Œè¨»å†Šã€å»ºç«‹å¸³è™Ÿï¼Œæˆ–ç”¨ Django Admin å»ºç«‹ç”¨æˆ¶<br>
            2. ç™»å…¥æˆåŠŸå¾Œï¼Œç€è¦½å™¨æœƒå„²å­˜ Session Cookieï¼Œä¹‹å¾Œå‘¼å«éœ€å¸¶ <code>credentials: 'include'</code><br>
            3. æœªç™»å…¥å‘¼å«å—ä¿è­· API æœƒè¿”å› 401
        </div>
        <div class="form-group">
            <label for="username">Email:</label>
            <input type="text" id="username" value="test@example.com" placeholder="è¼¸å…¥ Email">
        </div>
        <div class="form-group">
            <label for="password">å¯†ç¢¼:</label>
            <input type="password" id="password" value="testpass" placeholder="è¼¸å…¥å¯†ç¢¼">
        </div>
        <button onclick="registerUser()">è¨»å†Š</button>
        <button onclick="login()">ç™»å…¥</button>
        <button onclick="logout()">ç™»å‡º</button>
        <button onclick="checkAuth()">æª¢æŸ¥ç™»å…¥ç‹€æ…‹</button>
        <div id="loginStatus"></div>
    </div>


    <!-- æ‰“å¡è©•è«–æ¸¬è©¦ -->
    <div class="container">
        <h2>ğŸ“ æ‰“å¡è©•è«–æ¸¬è©¦</h2>
        <p><strong>æç¤º:</strong> è«‹å…ˆå‰µå»ºä¸€å€‹æ¸¬è©¦è©•è«–ï¼Œç„¶å¾Œä½¿ç”¨è¿”å›çš„è©•è«– ID ä¾†æ¸¬è©¦å…¶ä»–åŠŸèƒ½ã€‚</p>
        <div class="form-group">
            <label for="reviewId">è©•è«– ID:</label>
            <input type="number" id="reviewId" value="" placeholder="å…ˆå‰µå»ºè©•è«–ç²å– ID">
            <button onclick="createTestReview()">å‰µå»ºæ¸¬è©¦è©•è«–</button>
        </div>
        <button onclick="getReviewStats()">ç²å–è©•è«–çµ±è¨ˆ</button>
        <button onclick="toggleLike()">åˆ‡æ›å–œæ­¡</button>
        <button onclick="toggleFavorite()">åˆ‡æ›æ”¶è—</button>
        <div id="reviewResult"></div>
    </div>


    <!-- é€šçŸ¥æ¸¬è©¦ -->
    <div class="container">
        <h2>ğŸ”” é€šçŸ¥æ¸¬è©¦</h2>
        <button onclick="getNotifications()">ç²å–é€šçŸ¥åˆ—è¡¨</button>
        <button onclick="markAllRead()">æ¨™è¨˜å…¨éƒ¨å·²è®€</button>
        <div id="notificationsResult"></div>
    </div>


    <!-- æ”¶è—åˆ—è¡¨æ¸¬è©¦ -->
    <div class="container">
        <h2>â­ æ”¶è—åˆ—è¡¨æ¸¬è©¦</h2>
        <button onclick="getFavorites()">ç²å–æˆ‘çš„æ”¶è—</button>
        <div id="favoritesResult"></div>
    </div>


    <!-- æœƒå“¡è³‡æ–™æ¸¬è©¦ -->
    <div class="container">
        <h2>ğŸ‘¤ æœƒå“¡è³‡æ–™æ¸¬è©¦</h2>
        <div class="form-group">
            <label for="profileEmail">Email</label>
            <input type="email" id="profileEmail" placeholder="email@example.com">
        </div>
        <div class="form-group">
            <label for="displayName">å§“å</label>
            <input type="text" id="displayName" placeholder="é¡¯ç¤ºåç¨±">
        </div>
        <div class="form-group">
            <label for="gender">æ€§åˆ¥</label>
            <select id="gender">
                <option value="">æœªè¨­å®š</option>
                <option value="male">ç”·</option>
                <option value="female">å¥³</option>
                <option value="other">å…¶ä»–</option>
            </select>
        </div>
        <div class="form-group">
            <label for="birthday">ç”Ÿæ—¥</label>
            <input type="date" id="birthday">
        </div>
        <div class="form-group">
            <label for="phoneNumber">æ‰‹æ©Ÿè™Ÿç¢¼</label>
            <input type="text" id="phoneNumber" placeholder="09xxxxxxxx">
        </div>
        <button onclick="loadProfile()">è®€å–æœƒå“¡è³‡æ–™</button>
        <button onclick="updateProfile()">æ›´æ–°æœƒå“¡è³‡æ–™</button>
        <div class="form-group" style="margin-top:10px;">
            <label for="avatarFile">å¤§é ­è²¼</label>
            <input type="file" id="avatarFile" accept="image/*">
            <button onclick="uploadAvatar()">ä¸Šå‚³å¤§é ­è²¼</button>
        </div>
        <div id="avatarPreview" style="margin-top:10px;"></div>
        <div id="profileResult"></div>
    </div>


    <!-- å‰µå»ºæ¸¬è©¦è©•è«– -->
    <div class="container">
        <h2>â• å‰µå»ºæ¸¬è©¦è©•è«–</h2>
        <div class="form-group">
            <label for="restaurantName">é¤å»³åç¨±:</label>
            <input type="text" id="restaurantName" value="æ¸¬è©¦é¤å»³" placeholder="é¤å»³åç¨±">
        </div>
        <div class="form-group">
            <label for="metroLine">æ·é‹ç·š:</label>
            <input type="text" id="metroLine" value="æ·¡æ°´ä¿¡ç¾©ç·š" placeholder="æ·é‹ç·š">
        </div>
        <div class="form-group">
            <label for="rating">è©•åˆ†:</label>
            <select id="rating">
                <option value="1">1æ˜Ÿ</option>
                <option value="2">2æ˜Ÿ</option>
                <option value="3">3æ˜Ÿ</option>
                <option value="4">4æ˜Ÿ</option>
                <option value="5" selected>5æ˜Ÿ</option>
            </select>
        </div>
        <div class="form-group">
            <label for="comment">è©•è«–å…§å®¹:</label>
            <textarea id="comment" rows="3" placeholder="è©•è«–å…§å®¹">é€™æ˜¯ä¸€å€‹æ¸¬è©¦è©•è«–</textarea>
        </div>
        <button onclick="createReview()">å‰µå»ºè©•è«–</button>
        <div id="createResult"></div>
    </div>


    <script>
        const API_BASE = 'http://140.131.115.112:8000';
        let authToken = localStorage.getItem('authToken') || null; // è‹¥æ—¥å¾Œæ”¹ JWT å¯æ²¿ç”¨
        let currentUser = localStorage.getItem('currentUser') || null;


        // æ¸¬è©¦æœå‹™å™¨é€£æ¥
        async function testConnection() {
            // å…ˆæ¸¬è©¦åŸºæœ¬é€£æ¥
            try {
                const response = await fetch(`${API_BASE}/api/api/top-checkin-restaurants/`, {
                    credentials: 'include'
                });
                const text = await response.text();
               
                if (response.ok) {
                    showResult('connectionResult', `âœ… æœå‹™å™¨é€£æ¥æˆåŠŸ!\nç‹€æ…‹: ${response.status}\néŸ¿æ‡‰: ${text.substring(0, 100)}...`, 'success');
                } else {
                    showResult('connectionResult', `âš ï¸ æœå‹™å™¨éŸ¿æ‡‰ç•°å¸¸\nç‹€æ…‹: ${response.status}\néŸ¿æ‡‰: ${text.substring(0, 200)}...`, 'error');
                }
            } catch (error) {
                showResult('connectionResult', `âŒ é€£æ¥å¤±æ•—: ${error.message}\n\nå¯èƒ½çš„åŸå› :\n1. Django æœå‹™å™¨æœªå•Ÿå‹•\n2. ç«¯å£ 8000 æœªé–‹æ”¾\n3. CORS å•é¡Œ\n4. ç¶²çµ¡é€£æ¥å•é¡Œ\n\nè«‹æª¢æŸ¥:\n- åœ¨è™›æ“¬æ©Ÿä¸Šé‹è¡Œ: python manage.py runserver 0.0.0.0:8000\n- ç¢ºä¿é˜²ç«ç‰†å…è¨±ç«¯å£ 8000`, 'error');
            }
        }


        // æ›´æ–°ç™»å…¥ç‹€æ…‹é¡¯ç¤º
        function updateLoginStatus() {
            const statusDiv = document.getElementById('loginStatus');
            if (authToken && currentUser) {
                statusDiv.innerHTML = `<div class="success">âœ… å·²ç™»å…¥: ${currentUser}<br>Token: ${authToken.substring(0, 20)}...</div>`;
            } else {
                statusDiv.innerHTML = `<div class="error">âŒ æœªç™»å…¥<br>Token: ${authToken || 'null'}<br>User: ${currentUser || 'null'}</div>`;
            }
        }


        // ç²å– CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ï¼ˆåŸºæ–¼æœ¬åœ°æ¨™è¨˜ï¼‰
        function checkLogin() {
            if (!currentUser) {
                alert('âŒ è«‹å…ˆç™»å…¥ï¼');
                return false;
            }
            return true;
        }


        // è¨»å†Š
        async function registerUser() {
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (!email || !password) {
                showResult('loginStatus', 'è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼', 'error');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/accounts/register/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    currentUser = data.user?.username || email;
                    localStorage.setItem('currentUser', currentUser);
                    updateLoginStatus();
                    showResult('loginStatus', `âœ… è¨»å†Šä¸¦è‡ªå‹•ç™»å…¥æˆåŠŸ: ${currentUser}`, 'success');
                } else {
                    showResult('loginStatus', `âŒ è¨»å†Šå¤±æ•—:\n${JSON.stringify(data)}`, 'error');
                }
            } catch (e) {
                showResult('loginStatus', `âŒ è¨»å†ŠéŒ¯èª¤: ${e.message}`, 'error');
            }
        }


        // ç™»å…¥
        async function login() {
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (!email || !password) {
                showResult('loginStatus', 'è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼', 'error');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/accounts/login/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    currentUser = data.user?.username || email;
                    localStorage.setItem('currentUser', currentUser);
                    // è‹¥æœªä½¿ç”¨ JWTï¼Œå¯ä¸è¨­ç½® authToken
                    updateLoginStatus();
                    showResult('loginStatus', `âœ… ç™»å…¥æˆåŠŸ: ${currentUser}`, 'success');
                } else {
                    showResult('loginStatus', `âŒ ç™»å…¥å¤±æ•—:\n${JSON.stringify(data)}`, 'error');
                }
            } catch (e) {
                showResult('loginStatus', `âŒ ç™»å…¥éŒ¯èª¤: ${e.message}`, 'error');
            }
        }


        // ç™»å‡º
        async function logout() {
            try {
                await fetch(`${API_BASE}/api/accounts/logout/`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (_) {}
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            updateLoginStatus();
            showResult('loginStatus', 'âœ… å·²ç™»å‡º', 'success');
        }


        // å¾Œç«¯æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/api/accounts/user/`, {
                    credentials: 'include'
                });
                const data = await response.json();
                if (response.ok && data.isAuthenticated) {
                    currentUser = data.user?.username || data.user?.email || currentUser;
                    localStorage.setItem('currentUser', currentUser);
                    updateLoginStatus();
                    showResult('loginStatus', `âœ… å·²ç™»å…¥ (ä¼ºæœå™¨å›æ‡‰): ${currentUser}`, 'success');
                } else {
                    showResult('loginStatus', `âŒ æœªç™»å…¥ (ä¼ºæœå™¨å›æ‡‰)`, 'error');
                }
            } catch (e) {
                showResult('loginStatus', `âŒ æª¢æŸ¥ç™»å…¥éŒ¯èª¤: ${e.message}`, 'error');
            }
        }


        // å‰µå»ºæ¸¬è©¦è©•è«–
        async function createTestReview() {
            if (!checkLogin()) return;


            const reviewData = {
                restaurant_name: 'æ¸¬è©¦é¤å»³_' + Date.now(),
                metro_line: 'æ·¡æ°´ä¿¡ç¾©ç·š',
                reviewer_name: currentUser || 'æ¸¬è©¦ç”¨æˆ¶',
                rating: 5,
                comment: 'é€™æ˜¯ä¸€å€‹è‡ªå‹•å‰µå»ºçš„æ¸¬è©¦è©•è«–ï¼Œç”¨æ–¼æ¸¬è©¦å–œæ­¡å’Œæ”¶è—åŠŸèƒ½ã€‚'
            };


            try {
                const response = await fetch(`${API_BASE}/api/api/checkin-reviews/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    credentials: 'include',
                    body: JSON.stringify(reviewData)
                });
               
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    showResult('reviewResult', `API è¿”å›é JSON æ ¼å¼:\nç‹€æ…‹: ${response.status}\nå…§å®¹: ${text.substring(0, 200)}...`, 'error');
                    return;
                }
               
                const data = await response.json();
                if (response.ok) {
                    // è‡ªå‹•å¡«å…¥è©•è«– ID
                    document.getElementById('reviewId').value = data.review_id;
                    showResult('reviewResult', `âœ… æ¸¬è©¦è©•è«–å‰µå»ºæˆåŠŸ!\nè©•è«– ID: ${data.review_id}\né¤å»³: ${reviewData.restaurant_name}\nç¾åœ¨å¯ä»¥ä½¿ç”¨é€™å€‹ ID æ¸¬è©¦å…¶ä»–åŠŸèƒ½`, 'success');
                } else {
                    showResult('reviewResult', `âŒ å‰µå»ºè©•è«–å¤±æ•—:\n${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult('reviewResult', `âŒ å‰µå»ºè©•è«–éŒ¯èª¤: ${error.message}`, 'error');
            }
        }


        // ç²å–è©•è«–çµ±è¨ˆ
        async function getReviewStats() {
            const reviewId = document.getElementById('reviewId').value;
            if (!reviewId) {
                showResult('reviewResult', 'è«‹è¼¸å…¥è©•è«– ID', 'error');
                return;
            }


            try {
                const response = await fetch(`${API_BASE}/api/api/checkin-reviews/${reviewId}/stats/`, {
                    credentials: 'include'
                });
               
                // æª¢æŸ¥éŸ¿æ‡‰å…§å®¹é¡å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    showResult('reviewResult', `API è¿”å›é JSON æ ¼å¼:\nç‹€æ…‹: ${response.status}\nå…§å®¹: ${text.substring(0, 200)}...`, 'error');
                    return;
                }
               
                const data = await response.json();
                showResult('reviewResult', JSON.stringify(data, null, 2), response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('reviewResult', 'éŒ¯èª¤: ' + error.message, 'error');
            }
        }


        // åˆ‡æ›å–œæ­¡
        async function toggleLike() {
            if (!checkLogin()) return;


            const reviewId = document.getElementById('reviewId').value;
            if (!reviewId) {
                showResult('reviewResult', 'è«‹è¼¸å…¥è©•è«– ID', 'error');
                return;
            }
       
            try {
                const response = await fetch(`${API_BASE}/api/api/checkin-reviews/${reviewId}/like/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    credentials: 'include'
                });
               
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    showResult('reviewResult', `API è¿”å›é JSON æ ¼å¼:\nç‹€æ…‹: ${response.status}\nå…§å®¹: ${text.substring(0, 200)}...`, 'error');
                    return;
                }
               
                const data = await response.json();
                showResult('reviewResult', JSON.stringify(data, null, 2), response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('reviewResult', 'éŒ¯èª¤: ' + error.message, 'error');
            }
        }


        // åˆ‡æ›æ”¶è—
        async function toggleFavorite() {
            if (!checkLogin()) return;


            const reviewId = document.getElementById('reviewId').value;
            if (!reviewId) {
                showResult('reviewResult', 'è«‹è¼¸å…¥è©•è«– ID', 'error');
                return;
            }


            try {
                const response = await fetch(`${API_BASE}/api/api/checkin-reviews/${reviewId}/favorite/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    credentials: 'include'
                });
                const data = await response.json();
                showResult('reviewResult', JSON.stringify(data, null, 2), response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('reviewResult', 'éŒ¯èª¤: ' + error.message, 'error');
            }
        }


        // ç²å–é€šçŸ¥
        async function getNotifications() {
            if (!checkLogin()) return;
           
            try {
                const response = await fetch(`${API_BASE}/api/api/notifications/`, {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    credentials: 'include'
                });
                const data = await response.json();
               
                if (response.ok) {
                    let html = '';
                    // æœªè®€æ¸…å–®
                    html += `<h3>æœªè®€é€šçŸ¥ (${data.unread_count})</h3>`;
                    const unreadList = Array.isArray(data.unread_notifications) ? data.unread_notifications : [];
                    if (unreadList.length === 0) {
                        html += `<div class="notification-item read">ç›®å‰æ²’æœ‰æœªè®€é€šçŸ¥</div>`;
                    } else {
                        unreadList.forEach(notification => {
                            html += `
                                <div class="notification-item unread">
                                    <strong>${notification.title}</strong><br>
                                    ${notification.content}<br>
                                    <small>æ™‚é–“: ${notification.created_at} | ç™¼é€è€…: ${notification.sender}</small>
                                    <button onclick="markAsRead(${notification.id})">æ¨™è¨˜å·²è®€</button>
                                    <button onclick="deleteNotification(${notification.id})">åˆªé™¤</button>
                                </div>
                            `;
                        });
                    }


                    // å…¨éƒ¨æ¸…å–®
                    html += `<h3 style="margin-top:12px;">å…¨éƒ¨é€šçŸ¥</h3>`;
                    const allList = Array.isArray(data.notifications) ? data.notifications : [];
                    if (allList.length === 0) {
                        html += `<div class="notification-item read">ç›®å‰æ²’æœ‰é€šçŸ¥</div>`;
                    } else {
                        allList.forEach(notification => {
                            const className = notification.is_read ? 'read' : 'unread';
                            html += `
                                <div class="notification-item ${className}">
                                    <strong>${notification.title}</strong><br>
                                    ${notification.content}<br>
                                    <small>æ™‚é–“: ${notification.created_at} | ç™¼é€è€…: ${notification.sender}</small>
                                    <button onclick="markAsRead(${notification.id})">æ¨™è¨˜å·²è®€</button>
                                    <button onclick="deleteNotification(${notification.id})">åˆªé™¤</button>
                                </div>
                            `;
                        });
                    }


                    document.getElementById('notificationsResult').innerHTML = html;
                } else {
                    showResult('notificationsResult', JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                showResult('notificationsResult', 'éŒ¯èª¤: ' + error.message, 'error');
            }
        }


        // æ¨™è¨˜å…¨éƒ¨å·²è®€
        async function markAllRead() {
            if (!checkLogin()) return;
           
            try {
                const response = await fetch(`${API_BASE}/api/api/notifications/read-all/`, {
                    method: 'PUT',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    credentials: 'include'
                });
                const data = await response.json();
                if (response.ok) {
                    // æ›´æ–°åˆ—è¡¨é¡¯ç¤º
                    await getNotifications();
                } else {
                    showResult('notificationsResult', JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                showResult('notificationsResult', 'éŒ¯èª¤: ' + error.message, 'error');
            }
        }


        // æ¨™è¨˜å–®å€‹é€šçŸ¥ç‚ºå·²è®€
        async function markAsRead(notificationId) {
            try {
                const response = await fetch(`${API_BASE}/api/api/notifications/${notificationId}/read/`, {
                    method: 'PUT',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    credentials: 'include'
                });
                const data = await response.json();
                if (response.ok) {
                    getNotifications(); // é‡æ–°è¼‰å…¥é€šçŸ¥åˆ—è¡¨
                }
            } catch (error) {
                console.error('æ¨™è¨˜å·²è®€å¤±æ•—:', error);
            }
        }


        // åˆªé™¤é€šçŸ¥
        async function deleteNotification(notificationId) {
            try {
                const response = await fetch(`${API_BASE}/api/api/notifications/${notificationId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    credentials: 'include'
                });
                const data = await response.json();
                if (response.ok) {
                    getNotifications(); // é‡æ–°è¼‰å…¥é€šçŸ¥åˆ—è¡¨
                }
            } catch (error) {
                console.error('åˆªé™¤é€šçŸ¥å¤±æ•—:', error);
            }
        }


        // ç²å–æ”¶è—åˆ—è¡¨
        async function getFavorites() {
            try {
                const response = await fetch(`${API_BASE}/api/api/user/favorites/`, {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    credentials: 'include'
                });
                const data = await response.json();
               
                if (response.ok) {
                    let html = '<h3>æˆ‘çš„æ”¶è—åˆ—è¡¨</h3>';
                    data.favorites.forEach(favorite => {
                        html += `
                            <div class="notification-item">
                                <strong>${favorite.review.restaurant_name}</strong> (${favorite.review.metro_line})<br>
                                è©•åˆ†: ${favorite.review.rating}æ˜Ÿ<br>
                                è©•è«–: ${favorite.review.comment}<br>
                                <small>æ”¶è—æ™‚é–“: ${favorite.favorited_at}</small>
                            </div>
                        `;
                    });
                    document.getElementById('favoritesResult').innerHTML = html;
                } else {
                    showResult('favoritesResult', JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                showResult('favoritesResult', 'éŒ¯èª¤: ' + error.message, 'error');
            }
        }


        // å‰µå»ºæ¸¬è©¦è©•è«–
        async function createReview() {
            const reviewData = {
                restaurant_name: document.getElementById('restaurantName').value,
                metro_line: document.getElementById('metroLine').value,
                reviewer_name: currentUser || 'æ¸¬è©¦ç”¨æˆ¶',
                rating: parseInt(document.getElementById('rating').value),
                comment: document.getElementById('comment').value
            };


            try {
                const response = await fetch(`${API_BASE}/api/api/checkin-reviews/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    credentials: 'include',
                    body: JSON.stringify(reviewData)
                });
                const data = await response.json();
                showResult('createResult', JSON.stringify(data, null, 2), response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('createResult', 'éŒ¯èª¤: ' + error.message, 'error');
            }
        }


        // è®€å–æœƒå“¡è³‡æ–™ (GET /api/accounts/profile/)
        async function loadProfile() {
            if (!checkLogin()) return;
            try {
                const res = await fetch(`${API_BASE}/api/accounts/profile/`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await res.json();
                if (!res.ok) {
                    showResult('profileResult', JSON.stringify(data, null, 2), 'error');
                    return;
                }
                // å¡«å…¥è¡¨å–®
                document.getElementById('profileEmail').value = data.email || '';
                document.getElementById('displayName').value = data.display_name || '';
                document.getElementById('gender').value = data.gender || '';
                document.getElementById('birthday').value = data.birthday || '';
                document.getElementById('phoneNumber').value = data.phone_number || '';
                if (data.avatar_url) {
                    document.getElementById('avatarPreview').innerHTML = `<img src="${data.avatar_url}" alt="avatar" style="width:120px;height:120px;border-radius:50%;object-fit:cover;">`;
                } else {
                    document.getElementById('avatarPreview').innerHTML = '';
                }
                showResult('profileResult', 'âœ… å·²è¼‰å…¥æœƒå“¡è³‡æ–™', 'success');
            } catch (e) {
                showResult('profileResult', `éŒ¯èª¤: ${e.message}`, 'error');
            }
        }


        // æ›´æ–°æœƒå“¡è³‡æ–™ (PUT /api/accounts/profile/)
        async function updateProfile() {
            if (!checkLogin()) return;
            const payload = {
                email: document.getElementById('profileEmail').value || undefined,
                display_name: document.getElementById('displayName').value || '',
                gender: document.getElementById('gender').value || '',
                birthday: document.getElementById('birthday').value || '',
                phone_number: document.getElementById('phoneNumber').value || ''
            };
            try {
                const res = await fetch(`${API_BASE}/api/accounts/profile/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok) {
                    showResult('profileResult', 'âœ… æ›´æ–°æˆåŠŸ', 'success');
                    // æ›´æ–°ç™»å…¥ç‹€æ…‹é¡¯ç¤ºï¼ˆè‹¥ email è®Šæ›´ï¼‰
                    await checkAuth();
                    await loadProfile();
                } else {
                    showResult('profileResult', JSON.stringify(data, null, 2), 'error');
                }
            } catch (e) {
                showResult('profileResult', `éŒ¯èª¤: ${e.message}`, 'error');
            }
        }


        // ä¸Šå‚³å¤§é ­è²¼ (POST /api/accounts/profile/avatar/)
        async function uploadAvatar() {
            if (!checkLogin()) return;
            const fileInput = document.getElementById('avatarFile');
            if (!fileInput.files || fileInput.files.length === 0) {
                showResult('profileResult', 'è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ', 'error');
                return;
            }
            const form = new FormData();
            form.append('avatar', fileInput.files[0]);
            try {
                const res = await fetch(`${API_BASE}/api/accounts/profile/avatar/`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') || '' },
                    body: form
                });
                const data = await res.json();
                if (res.ok) {
                    showResult('profileResult', 'âœ… å¤§é ­è²¼ä¸Šå‚³æˆåŠŸ', 'success');
                    document.getElementById('avatarPreview').innerHTML = `<img src="${data.avatar_url}" alt="avatar" style="width:120px;height:120px;border-radius:50%;object-fit:cover;">`;
                } else {
                    showResult('profileResult', JSON.stringify(data, null, 2), 'error');
                }
            } catch (e) {
                showResult('profileResult', `éŒ¯èª¤: ${e.message}`, 'error');
            }
        }


        // é¡¯ç¤ºçµæœ
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }


        // é é¢è¼‰å…¥æ™‚åŒæ­¥ä¼ºæœå™¨ç™»å…¥ç‹€æ…‹
        window.onload = function() {
            updateLoginStatus(); // å…ˆé¡¯ç¤ºæœ¬åœ°ç‹€æ…‹
            checkAuth();         // å†ä»¥ä¼ºæœå™¨ç‚ºæº–åŒæ­¥ç‹€æ…‹
        };
    </script>
</body>
</html>






