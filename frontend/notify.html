<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>通知</title>
  <link rel="icon" href="/圖片/logo.png" type="image/x-icon">
  <link rel="stylesheet" href="static/css/notify.css" />


</head>
<body>
  <div class="container rwd-container">
    <h1 class="title">通知</h1>

    <div class="notify-buttons">
      <button id="btn-all">全部</button>
      <button id="btn-unread">未讀</button>
      <button id="btn-mark-all">全部標記已讀</button>
    </div>

    <!-- ✅ 新增這個渲染容器，前面的 getNotifications 就是缺這個 -->
    <div id="notificationsResult"></div>
  </div>

  <nav class="footer">
    <a class="nav-btn" id="home" href="homepage.html">
      <img src="圖片/home.png" alt="首頁"><span>首頁</span>
    </a>
    <a class="nav-btn" id="map" href="food_map.html">
      <img src="圖片/map.png" alt="美食地圖"><span>美食地圖</span>
    </a>
    <a class="nav-btn" id="notify" href="notify.html">
      <img src="圖片/bell.png" alt="通知" /><span>通知</span>
    </a>
    <a class="nav-btn" href="Member_center.html">
      <img src="圖片/user.png" alt="會員中心"><span>會員中心</span>
    </a>
  </nav>

  
</body>
<script>
"use strict";

const NOTIFY_KEY = "notifications_v1";

// 讀/寫
function loadNoti(){ try{return JSON.parse(localStorage.getItem(NOTIFY_KEY))||[];}catch{return[];} }
function saveNoti(list){ localStorage.setItem(NOTIFY_KEY, JSON.stringify(list)); }

// 小工具
function fmt(t){ const d=new Date(t); const p=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
}

function renderNoti(filter="all"){
  const box = document.getElementById("notificationsResult");
  let list = loadNoti().sort((a,b)=> new Date(b.time)-new Date(a.time));
  if(filter==="unread") list = list.filter(n=>!n.read);

  if(!list.length){ box.innerHTML = '<p class="empty">目前沒有通知</p>'; return; }

  box.innerHTML = list.map(n=>`
    <div class="notification-item ${n.read?'read':''}" data-id="${n.id}">
      <button class="nt-close" aria-label="刪除通知" title="刪除">×</button>
      <div class="nt-title">${n.title}</div>
      <div class="nt-msg">${n.message}</div>
      <div class="nt-meta">${fmt(n.time)}</div>
      ${n.item?.name ? `<div class="nt-link"><a href="store_details.html?name=${encodeURIComponent(n.item.name)}">查看店家</a></div>` : ""}
    </div>
  `).join("");

  // 點整張 → 標記已讀
  box.querySelectorAll(".notification-item").forEach(el=>{
    el.addEventListener("click", ()=>{
      const id = el.dataset.id;
      const all = loadNoti();
      const i = all.findIndex(x=>x.id===id);
      if(i>-1){ all[i].read = true; saveNoti(all); el.classList.add("read"); }
    });
  });

  // 右上角 × → 刪除
  box.querySelectorAll(".nt-close").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.stopPropagation(); // 避免同時觸發「已讀」
      const card = btn.closest(".notification-item");
      const id = card.dataset.id;
      const all = loadNoti().filter(n => n.id !== id);
      saveNoti(all);
      card.remove();
      if (!all.length) box.innerHTML = '<p class="empty">目前沒有通知</p>';
    });
  });
}


// 上方三顆按鈕
document.getElementById("btn-all").addEventListener("click", ()=>renderNoti("all"));
document.getElementById("btn-unread").addEventListener("click", ()=>renderNoti("unread"));
document.getElementById("btn-mark-all").addEventListener("click", ()=>{
  const list = loadNoti(); list.forEach(n=>n.read=true); saveNoti(list); renderNoti("all");
});

// 初始渲染
document.addEventListener("DOMContentLoaded", ()=>renderNoti("all"));
</script>

</html>
